!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define("MCanvas",e):t.MCanvas=e()}(this,function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i={extend:function(t,i){for(var o in i)i.hasOwnProperty(o)&&("object"==e(i[o])?("object"===e(t[o])&&null!==t[o]||(t[o]={}),this.extend(t[o],i[o])):t[o]=i[o]);return t},loadImage:function(t,e,i){var o=new Image;0==t.indexOf("http")&&(o.crossOrigin="*"),o.onload=function(){e(o)},o.onerror=function(){i("img load error")},o.src=t},isArr:function(t){return"[object Array]"===Object.prototype.toString.call(t)},getImage:function(t,i){if("string"==typeof t)this.loadImage(t,function(t){i(t)},function(t){console.log(t)});else{if("object"!=(void 0===t?"undefined":e(t)))return void console.log("add image error");i(t)}},forin:function(t,e){for(var i in t)t.hasOwnProperty(i)&&e(i,t[i])}},o=function(){function t(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,i,o){return i&&t(e.prototype,i),o&&t(e,o),e}}();return function(){function e(i,o){t(this,e),this.ops={width:i||500,height:o||i},this.canvas=null,this.ctx=null,this.queue=[],this.end=null,this.textData={},this.bgConfig=null,this._init()}return o(e,[{key:"_init",value:function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.ops.width,this.canvas.height=this.ops.height,this.ctx=this.canvas.getContext("2d")}},{key:"background",value:function(t){var e=this;return!t&&this.bgConfig&&(t=this.bgConfig),this.bgConfig=t,this.queue.push(function(){t.color&&(e.ctx.fillStyle=t.color,e.ctx.fillRect(0,0,e.canvas.width,e.canvas.height)),t.image&&i.getImage(t.image,function(i){e._background(i,t)})}),this}},{key:"_background",value:function(t,e){var i=t.width/t.height,o=this.canvas.width/this.canvas.height,n=void 0,a=void 0,h=void 0,s=void 0,r=void 0,c=void 0,l=void 0,d=void 0;switch(e.type){case"crop":n=e.left||0,a=e.top||0,i>o?(h=t.height*o,s=t.height):(h=t.width,s=h/o),c=r=0,d=this.canvas.height,l=this.canvas.width;break;case"contain":a=n=0,h=t.width,s=t.height,i>o?(l=this.canvas.width,d=l/i,r=e.left||0,c=e.top||0==e.top?e.top:(this.canvas.height-d)/2):(d=this.canvas.height,l=d*i,c=e.top||0,r=e.left||0==e.left?e.left:(this.canvas.width-l)/2);break;case"origin":this.canvas.width=t.width,this.canvas.height=t.height,n=a=0,h=t.width,s=t.height,r=c=0,l=this.canvas.width,d=this.canvas.height;break;default:console.err("background type error!")}this.ctx.drawImage(t,n,a,h,s,r,c,l,d),this._next()}},{key:"watermark",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=arguments[1];if(!t)return void console.log("there is not image of watermark");var i=e.width,o=void 0===i?"40%":i,n=e.pos,a=void 0===n?"rightbottom":n,h=e.margin,s=void 0===h?20:h,r={x:0,y:0,scale:1,rotate:0};switch(a){case"leftTop":r.x="left:"+s,r.y="top:"+s;break;case"leftBottom":r.x="left:"+s,r.y="bottom:"+s;break;case"rightTop":r.x="right:"+s,r.y="top:"+s;break;case"rightBottom":r.x="right:"+s,r.y="bottom:"+s}return this.add(t,{width:o,pos:r}),this}},{key:"add",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=arguments[1],n={width:"100%",crop:{x:0,y:0,width:"100%",height:"100%"},pos:{x:0,y:0,scale:1,rotate:0}};return i.isArr(e)||(e=[{image:e,options:o}]),e.forEach(function(e){t.queue.push(function(){i.getImage(e.image,function(o){t._add(o,t._handleOps(i.extend(n,e.options),o))})})}),this}},{key:"_add",value:function(t,e){var i=t.width/t.height,o=void 0,n=void 0,a=void 0,h=void 0,s=e.crop,r=s.x,c=s.y,l=s.width,d=s.height,u=void 0,f=void 0,g=void 0,v=void 0,p=void 0,x=void 0,y=void 0,w=void 0,m=document.createElement("canvas"),b=m.getContext("2d");m.height=m.width=i>1?t.width:t.height,u=-t.width/2,f=-t.height/2,g=t.width,v=t.height,b.translate(m.width/2,m.height/2),b.rotate(e.pos.rotate),b.drawImage(t,r,c,l,d,u,f,g,v),h=a=e.width,i>1?(x=a/i,p=0,y=0,w=(h-x)/2):(p=h*i,x=0,y=(a-p)/2,w=0),o=e.pos.x+a*(1-e.pos.scale)/2-y,n=e.pos.y+h*(1-e.pos.scale)/2-w,h=a*=e.pos.scale,this.ctx.drawImage(m,o,n,a,h),this._next()}},{key:"_handleOps",value:function(t,e){var i=this.canvas.width,o=this.canvas.height,n=e.width,a=e.height,h=n/a,s=this._get(i,n,t.width,"pos"),r=void 0,c=void 0,l=t.crop,d=l.x,u=l.y,f=l.width,g=l.height,v={x:this._get(i,n,d,"crop"),y:this._get(o,a,u,"crop"),width:this._get(i,n,f,"crop"),height:this._get(o,a,g,"crop")};v.x>n&&(v.x=n),v.y>a&&(v.y=a),r=e.width-v.x,c=e.height-v.y,v.width>r&&(v.width=r),v.height>c&&(v.height=c);var p=t.pos,x=p.x,y=p.y,w=p.rotate,m=p.scale;return{width:s,crop:v,pos:{x:this._get(i,s,x,"pos"),y:this._get(o,s/h,y,"pos"),scale:m,rotate:parseFloat(w)*Math.PI/180}}}},{key:"text",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=arguments[1],n="helvetica neue,hiragino sans gb,Microsoft YaHei,arial,tahoma,sans-serif",a=this.canvas.width/20;return this.queue.push(function(){var h={width:300,align:"left",smallStyle:{font:.8*a+"px "+n,color:"#000",lineheight:.9*a},normalStyle:{font:a+"px "+n,color:"#000",lineheight:1.1*a},largeStyle:{font:1.3*a+"px "+n,color:"#000",lineheight:1.4*a},pos:{x:0,y:0}};h=i.extend(h,o),t._text(t._parse(e),h),t._next()}),this}},{key:"_parse",value:function(t){for(var e=t.split(/<s>|<b>/),i=[],o=0;o<e.length;o++){var n=e[o];if(/<\/s>|<\/b>/.test(n)){var a=/<\/s>/.test(n)?"</s>":"</b>",h=/<\/s>/.test(n)?"small":"large",s=e[o].split(a);i.push({type:h,text:s[0]}),s[1]&&i.push({type:"normal",text:s[1]})}else e[o]&&i.push({text:e[o],type:"normal"})}return i}},{key:"_text",value:function(t,e){var o=this;e.width=this._get(this.canvas.width,0,e.width,"pos");var n=void 0,a=1,h=0,s=function(t,e){var i=0,o=void 0;return t.forEach(function(t){(o=e[t.type+"Style"].lineheight)>i&&(i=o)}),i}(t,e),r=this._get(this.canvas.width,e.width,e.pos.x,"pos"),c=this._get(this.canvas.height,0,e.pos.y,"pos")+s;this.textData[a]={data:[],lineWidth:0},t.forEach(function(t){n=e[t.type+"Style"],o.ctx.font=n.font;var i=o.ctx.measureText(t.text).width,l=t.text.replace(/<br>/g,"|");if(h+i>e.width||-1!==l.indexOf("|"))for(var d=0,u=l.length;d<u;d++){var f=l[d];i=o.ctx.measureText(f).width,(h+i>e.width||"|"==f)&&(h=0,r=o._get(o.canvas.width,e.width,e.pos.x,"pos"),c+=s,a+=1,o.textData[a]={data:[],lineWidth:0},"|"==f)||(o.textData[a].data.push({context:f,x:r,y:c,style:n,width:i}),h+=i,r+=i,o.textData[a].lineWidth=h)}else o.textData[a].data.push({context:l,x:r,y:c,style:n,width:i}),h+=i,r+=i,o.textData[a].lineWidth=h}),i.forin(this.textData,function(t,i){var n=0;i.lineWidth<e.width&&("center"==e.align?n=(e.width-i.lineWidth)/2:"right"==e.align&&(n=e.width-i.lineWidth)),i.data.forEach(function(t){t.x+=n,o._fillText(t)})})}},{key:"_fillText",value:function(t){var e=t.context,i=t.x,o=t.y,n=t.style;this.ctx.font=n.font,this.ctx.textAlign=n.align,this.ctx.textBaseline="bottom",this.ctx.fillStyle=n.color,this.ctx.fillText(e,i,o)}},{key:"_get",value:function(t,e,i,o){var n=i;if("string"==typeof i)if(-1!==i.indexOf(":")&&"pos"==o){var a=i.split(":");switch(a[0]){case"left":case"top":n=+a[1].replace("px","");break;case"right":case"bottom":n=t-+a[1].replace("px","")-e}}else n=-1!==i.indexOf("px")?+i.replace("px",""):-1!==i.indexOf("%")?"crop"==o?e*+i.replace("%","")/100:t*+i.replace("%","")/100:"center"==i?(t-e)/2:+i;return n}},{key:"draw",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){},i=void 0;return this.end=function(){setTimeout(function(){i=t.canvas.toDataURL("image/png"),e(i)},0)},this._next(),this}},{key:"_next",value:function(){this.queue.length>0?this.queue.shift()():this.end()}}]),e}()});
//# sourceMappingURL=canvas.min.js.map
