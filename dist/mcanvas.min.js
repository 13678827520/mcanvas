!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.MCanvas=e()}(this,function(){"use strict";function t(e,i,o){if(!(this instanceof t))return new t(e,i,o);this.ops={width:e||500,height:i||e,background:o},this.canvas=null,this.ctx=null,this.queue=[],this.end=null,this.textData={},this.bgConfig=null,this._init()}var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i={extend:function(t,i){for(var o in i)i.hasOwnProperty(o)&&("object"==e(i[o])?("object"===e(t[o])&&null!==t[o]||(t[o]={}),this.extend(t[o],i[o])):t[o]=i[o]);return t},loadImage:function(t,e,i){var o=new Image;0==t.indexOf("http")&&(o.crossOrigin="*"),o.onload=function(){e(o)},o.onerror=function(){i("img load error")},o.src=t},isArr:function(t){return"[object Array]"===Object.prototype.toString.call(t)},getImage:function(t,i){if("string"==typeof t)this.loadImage(t,function(t){i(t)},function(t){console.log(t)});else{if("object"!=(void 0===t?"undefined":e(t)))return void console.log("add image error");i(t)}},forin:function(t,e){for(var i in t)t.hasOwnProperty(i)&&e(i,t[i])}};return t.prototype._init=function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.ops.width,this.canvas.height=this.ops.height,this.ctx=this.canvas.getContext("2d"),this.ops.background&&(this.ctx.fillStyle=this.ops.background,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height))},t.prototype.background=function(t,e){var o=this;if(e||t)e.image=t,this.bgConfig=e;else{if(!this.bgConfig)return void console.error("mcanvas error : the init background must has the bg option params.");e=this.bgConfig}return this.queue.push(function(){e.color&&(o.ctx.fillStyle=e.color,o.ctx.fillRect(0,0,o.canvas.width,o.canvas.height)),e.image?i.getImage(e.image,function(t){o._background(t,e)}):console.error("mcanvas error : background image error!")}),this},t.prototype._background=function(t,e){var i=this._getSize(t),o=i.iw,n=i.ih,a=o/n,s=this.canvas.width/this.canvas.height,h=void 0,r=void 0,c=void 0,l=void 0,d=void 0,p=void 0,f=void 0,g=void 0;switch(e.type){case"crop":h=e.left||0,r=e.top||0,a>s?(c=n*s,l=n):(c=o,l=c/s),p=d=0,g=this.canvas.height,f=this.canvas.width;break;case"contain":r=h=0,c=o,l=n,a>s?(f=this.canvas.width,g=f/a,d=e.left||0,p=e.top||0==e.top?e.top:(this.canvas.height-g)/2):(g=this.canvas.height,f=g*a,p=e.top||0,d=e.left||0==e.left?e.left:(this.canvas.width-f)/2);break;case"origin":this.canvas.width=o,this.canvas.height=n,h=r=0,c=o,l=n,d=p=0,f=this.canvas.width,g=this.canvas.height;break;default:console.error("mcanvas error:background type error!")}this.ctx.drawImage(t,h,r,c,l,d,p,f,g),this._next()},t.prototype.watermark=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=arguments[1];if(!t)return void console.error("mcanvas error : there is not image of watermark.");var i=e.width,o=void 0===i?"40%":i,n=e.pos,a=void 0===n?"rightbottom":n,s=e.margin,h=void 0===s?20:s,r={x:0,y:0,scale:1,rotate:0};switch(a){case"leftTop":r.x="left:"+h,r.y="top:"+h;break;case"leftBottom":r.x="left:"+h,r.y="bottom:"+h;break;case"rightTop":r.x="right:"+h,r.y="top:"+h;break;case"rightBottom":r.x="right:"+h,r.y="bottom:"+h}return this.add(t,{width:o,pos:r}),this},t.prototype.add=function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=arguments[1],n={width:"100%",crop:{x:0,y:0,width:"100%",height:"100%"},pos:{x:0,y:0,scale:1,rotate:0}};return i.isArr(e)||(e=[{image:e,options:o}]),e.forEach(function(e){t.queue.push(function(){i.getImage(e.image,function(o){t._add(o,t._handleOps(i.extend(n,e.options),o))})})}),this},t.prototype._add=function(t,e){0==e.width&&console.warn("mcanvas warn: the width of mc-element is zero");var i=this._getSize(t),o=i.iw,n=i.ih,a=void 0,s=void 0,h=void 0,r=void 0,c=e.crop,l=c.x,d=c.y,p=c.width,f=c.height,g=p/f,u=void 0,v=void 0,x=void 0,y=void 0,w=document.createElement("canvas"),m=w.getContext("2d"),b=o>n?o/n:n/o,_=1.4*b>5?5:1.4*b,k=void 0,S=void 0;w.width=p*_,w.height=f*_,u=-p/2,v=-f/2,x=p,y=p/g,m.translate(w.width/2,w.height/2),m.rotate(e.pos.rotate),m.drawImage(t,l,d,p,f,u,v,x,y),h=e.width*_,r=h/g,k=(_-1)*e.width/2,S=k/g,a=e.pos.x+h*(1-e.pos.scale)/2-k,s=e.pos.y+r*(1-e.pos.scale)/2-S,h*=e.pos.scale,r*=e.pos.scale,this.ctx.drawImage(w,a,s,h,r),w=m=null,this._next()},t.prototype._getSize=function(t){var e=void 0,i=void 0;return"IMG"===t.tagName?(e=t.naturalWidth,i=t.naturalHeight):"CANVAS"===t.tagName?(e=t.width,i=t.height):(e=t.offsetWidth,i=t.offsetHeight),{iw:e,ih:i}},t.prototype._handleOps=function(t,e){var i=this.canvas.width,o=this.canvas.height,n=this._getSize(e),a=n.iw,s=n.ih,h=a/s,r=this._get(i,a,t.width,"pos"),c=void 0,l=void 0,d=t.crop,p=d.x,f=d.y,g=d.width,u=d.height,v={};v.width=this._get(i,a,g,"crop"),v.height=this._get(o,s,u,"crop"),v.x=this._get(a,v.width,p,"crop"),v.y=this._get(s,v.height,f,"crop"),console.log(v),v.x>a&&(v.x=a),v.y>s&&(v.y=s),c=a-v.x,l=s-v.y,v.width>c&&(v.width=c),v.height>l&&(v.height=l);var x=t.pos,y=x.x,w=x.y,m=x.rotate,b=x.scale;return{width:r,crop:v,pos:{x:this._get(i,r,y,"pos"),y:this._get(o,r/h,w,"pos"),scale:b,rotate:parseFloat(m)*Math.PI/180}}},t.prototype.text=function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=arguments[1],n="helvetica neue,hiragino sans gb,Microsoft YaHei,arial,tahoma,sans-serif",a=this.canvas.width/20;return this.queue.push(function(){var s={width:300,align:"left",smallStyle:{font:.8*a+"px "+n,color:"#000",lineheight:.9*a},normalStyle:{font:a+"px "+n,color:"#000",lineheight:1.1*a},largeStyle:{font:1.3*a+"px "+n,color:"#000",lineheight:1.4*a},pos:{x:0,y:0}};s=i.extend(s,o),t._text(t._parse(e),s),t._next()}),this},t.prototype._parse=function(t){for(var e=t.split(/<s>|<b>/),i=[],o=0;o<e.length;o++){var n=e[o];if(/<\/s>|<\/b>/.test(n)){var a=/<\/s>/.test(n)?"</s>":"</b>",s=/<\/s>/.test(n)?"small":"large",h=e[o].split(a);i.push({type:s,text:h[0]}),h[1]&&i.push({type:"normal",text:h[1]})}else e[o]&&i.push({text:e[o],type:"normal"})}return i},t.prototype._text=function(t,e){var o=this;e.width=this._get(this.canvas.width,0,e.width,"pos");var n=void 0,a=1,s=0,h=function(t,e){var i=0,o=void 0;return t.forEach(function(t){(o=e[t.type+"Style"].lineheight)>i&&(i=o)}),i}(t,e),r=this._get(this.canvas.width,e.width,e.pos.x,"pos"),c=this._get(this.canvas.height,0,e.pos.y,"pos")+h;this.textData[a]={data:[],lineWidth:0},t.forEach(function(t){n=e[t.type+"Style"],o.ctx.font=n.font;var i=o.ctx.measureText(t.text).width,l=t.text.replace(/<br>/g,"|");if(s+i>e.width||-1!==l.indexOf("|"))for(var d=0,p=l.length;d<p;d++){var f=l[d];i=o.ctx.measureText(f).width,(s+i>e.width||"|"==f)&&(s=0,r=o._get(o.canvas.width,e.width,e.pos.x,"pos"),c+=h,a+=1,o.textData[a]={data:[],lineWidth:0},"|"==f)||(o.textData[a].data.push({context:f,x:r,y:c,style:n,width:i}),s+=i,r+=i,o.textData[a].lineWidth=s)}else o.textData[a].data.push({context:l,x:r,y:c,style:n,width:i}),s+=i,r+=i,o.textData[a].lineWidth=s}),i.forin(this.textData,function(t,i){var n=0;i.lineWidth<e.width&&("center"==e.align?n=(e.width-i.lineWidth)/2:"right"==e.align&&(n=e.width-i.lineWidth)),i.data.forEach(function(t){t.x+=n,o._fillText(t)})})},t.prototype._fillText=function(t){var e=t.context,i=t.x,o=t.y,n=t.style;this.ctx.font=n.font,this.ctx.textAlign=n.align,this.ctx.textBaseline="bottom",this.ctx.fillStyle=n.color,this.ctx.fillText(e,i,o)},t.prototype._get=function(t,e,i,o){var n=i;if("string"==typeof i)if(-1!==i.indexOf(":")&&"pos"==o){var a=i.split(":");switch(a[0]){case"left":case"top":n=+a[1].replace("px","");break;case"right":case"bottom":n=t-+a[1].replace("px","")-e}}else n=-1!==i.indexOf("px")?+i.replace("px",""):-1!==i.indexOf("%")?"crop"==o?e*+i.replace("%","")/100:t*+i.replace("%","")/100:"center"==i?(t-e)/2:+i;return n},t.prototype.draw=function(t){var e=this,o=void 0,n={type:"png",quality:.9,callback:function(){}};return"function"==typeof t?n.callback=t:(n=i.extend(n,t),"jpg"==n.type&&(n.type="jpeg")),this.end=function(){setTimeout(function(){o=e.canvas.toDataURL("image/"+n.type,n.quality),n.callback(o)},0)},this._next(),this},t.prototype._next=function(){this.queue.length>0?this.queue.shift()():this.end()},t});
//# sourceMappingURL=mcanvas.min.js.map
