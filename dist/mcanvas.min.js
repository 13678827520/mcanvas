!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):t.MCanvas=i()}(this,function(){"use strict";function t(i,e,o){if(!(this instanceof t))return new t(i,e,o);this.ops={width:i||500,height:e||i,background:o},this.canvas=null,this.ctx=null,this.queue=[],this.end=null,this.textData={},this.bgConfig=null,this._init()}var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e={extend:function(t,e){for(var o in e)e.hasOwnProperty(o)&&("object"==i(e[o])?("object"===i(t[o])&&null!==t[o]||(t[o]={}),this.extend(t[o],e[o])):t[o]=e[o]);return t},loadImage:function(t,i,e){var o=new Image;0==t.indexOf("http")&&(o.crossOrigin="*"),o.onload=function(){i(o)},o.onerror=function(){e("img load error")},o.src=t},isArr:function(t){return"[object Array]"===Object.prototype.toString.call(t)},getImage:function(t,e){if("string"==typeof t)this.loadImage(t,function(t){e(t)},function(t){console.log(t)});else{if("object"!=(void 0===t?"undefined":i(t)))return void console.log("add image error");e(t)}},forin:function(t,i){for(var e in t)t.hasOwnProperty(e)&&i(e,t[e])}};return t.prototype._init=function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.ops.width,this.canvas.height=this.ops.height,this.ctx=this.canvas.getContext("2d"),this.ops.background&&(this.ctx.fillStyle=this.ops.background,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height))},t.prototype.background=function(t){var i=this;return!t&&this.bgConfig&&(t=this.bgConfig),this.bgConfig=t,this.queue.push(function(){t.color&&(i.ctx.fillStyle=t.color,i.ctx.fillRect(0,0,i.canvas.width,i.canvas.height)),t.image?e.getImage(t.image,function(e){i._background(e,t)}):console.error("background image error!")}),this},t.prototype._background=function(t,i){var e=t.naturalWidth/t.naturalHeight,o=this.canvas.width/this.canvas.height,a=void 0,n=void 0,h=void 0,s=void 0,r=void 0,c=void 0,l=void 0,d=void 0;switch(i.type){case"crop":a=i.left||0,n=i.top||0,e>o?(h=t.naturalHeight*o,s=t.naturalHeight):(h=t.naturalWidth,s=h/o),c=r=0,d=this.canvas.height,l=this.canvas.width;break;case"contain":n=a=0,h=t.naturalWidth,s=t.naturalHeight,e>o?(l=this.canvas.width,d=l/e,r=i.left||0,c=i.top||0==i.top?i.top:(this.canvas.height-d)/2):(d=this.canvas.height,l=d*e,c=i.top||0,r=i.left||0==i.left?i.left:(this.canvas.width-l)/2);break;case"origin":this.canvas.width=t.naturalWidth,this.canvas.height=t.naturalHeight,a=n=0,h=t.naturalWidth,s=t.naturalHeight,r=c=0,l=this.canvas.width,d=this.canvas.height;break;default:console.error("background type error!")}this.ctx.drawImage(t,a,n,h,s,r,c,l,d),this._next()},t.prototype.watermark=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=arguments[1];if(!t)return void console.log("there is not image of watermark");var e=i.width,o=void 0===e?"40%":e,a=i.pos,n=void 0===a?"rightbottom":a,h=i.margin,s=void 0===h?20:h,r={x:0,y:0,scale:1,rotate:0};switch(n){case"leftTop":r.x="left:"+s,r.y="top:"+s;break;case"leftBottom":r.x="left:"+s,r.y="bottom:"+s;break;case"rightTop":r.x="right:"+s,r.y="top:"+s;break;case"rightBottom":r.x="right:"+s,r.y="bottom:"+s}return this.add(t,{width:o,pos:r}),this},t.prototype.add=function(){var t=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=arguments[1],a={width:"100%",crop:{x:0,y:0,width:"100%",height:"100%"},pos:{x:0,y:0,scale:1,rotate:0}};return e.isArr(i)||(i=[{image:i,options:o}]),i.forEach(function(i){t.queue.push(function(){e.getImage(i.image,function(o){t._add(o,t._handleOps(e.extend(a,i.options),o))})})}),this},t.prototype._add=function(t,i){var e=t.naturalWidth/t.naturalHeight,o=void 0,a=void 0,n=void 0,h=void 0,s=i.crop,r=s.x,c=s.y,l=s.width,d=s.height,p=void 0,u=void 0,g=void 0,f=void 0,v=document.createElement("canvas"),x=v.getContext("2d"),y=1.4*e>5?5:1.4*e,w=void 0,m=void 0;v.width=t.naturalWidth*y,v.height=t.naturalHeight*y,p=-t.naturalWidth/2,u=-t.naturalHeight/2,g=t.naturalWidth,f=t.naturalHeight,x.translate(v.width/2,v.height/2),x.rotate(i.pos.rotate),x.drawImage(t,r,c,l,d,p,u,g,f),n=i.width*y,h=n/e,w=(y-1)*i.width/2,m=w/e,o=i.pos.x+n*(1-i.pos.scale)/2-w,a=i.pos.y+h*(1-i.pos.scale)/2-m,n*=i.pos.scale,h*=i.pos.scale,this.ctx.drawImage(v,o,a,n,h),v=x=null,this._next()},t.prototype._handleOps=function(t,i){var e=this.canvas.width,o=this.canvas.height,a=i.naturalWidth,n=i.naturalHeight,h=a/n,s=this._get(e,a,t.width,"pos"),r=void 0,c=void 0,l=t.crop,d=l.x,p=l.y,u=l.width,g=l.height,f={x:this._get(e,a,d,"crop"),y:this._get(o,n,p,"crop"),width:this._get(e,a,u,"crop"),height:this._get(o,n,g,"crop")};f.x>a&&(f.x=a),f.y>n&&(f.y=n),r=i.naturalWidth-f.x,c=i.naturalHeight-f.y,f.width>r&&(f.width=r),f.height>c&&(f.height=c);var v=t.pos,x=v.x,y=v.y,w=v.rotate,m=v.scale;return{width:s,crop:f,pos:{x:this._get(e,s,x,"pos"),y:this._get(o,s/h,y,"pos"),scale:m,rotate:parseFloat(w)*Math.PI/180}}},t.prototype.text=function(){var t=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=arguments[1],a="helvetica neue,hiragino sans gb,Microsoft YaHei,arial,tahoma,sans-serif",n=this.canvas.width/20;return this.queue.push(function(){var h={width:300,align:"left",smallStyle:{font:.8*n+"px "+a,color:"#000",lineheight:.9*n},normalStyle:{font:n+"px "+a,color:"#000",lineheight:1.1*n},largeStyle:{font:1.3*n+"px "+a,color:"#000",lineheight:1.4*n},pos:{x:0,y:0}};h=e.extend(h,o),t._text(t._parse(i),h),t._next()}),this},t.prototype._parse=function(t){for(var i=t.split(/<s>|<b>/),e=[],o=0;o<i.length;o++){var a=i[o];if(/<\/s>|<\/b>/.test(a)){var n=/<\/s>/.test(a)?"</s>":"</b>",h=/<\/s>/.test(a)?"small":"large",s=i[o].split(n);e.push({type:h,text:s[0]}),s[1]&&e.push({type:"normal",text:s[1]})}else i[o]&&e.push({text:i[o],type:"normal"})}return e},t.prototype._text=function(t,i){var o=this;i.width=this._get(this.canvas.width,0,i.width,"pos");var a=void 0,n=1,h=0,s=function(t,i){var e=0,o=void 0;return t.forEach(function(t){(o=i[t.type+"Style"].lineheight)>e&&(e=o)}),e}(t,i),r=this._get(this.canvas.width,i.width,i.pos.x,"pos"),c=this._get(this.canvas.height,0,i.pos.y,"pos")+s;this.textData[n]={data:[],lineWidth:0},t.forEach(function(t){a=i[t.type+"Style"],o.ctx.font=a.font;var e=o.ctx.measureText(t.text).width,l=t.text.replace(/<br>/g,"|");if(h+e>i.width||-1!==l.indexOf("|"))for(var d=0,p=l.length;d<p;d++){var u=l[d];e=o.ctx.measureText(u).width,(h+e>i.width||"|"==u)&&(h=0,r=o._get(o.canvas.width,i.width,i.pos.x,"pos"),c+=s,n+=1,o.textData[n]={data:[],lineWidth:0},"|"==u)||(o.textData[n].data.push({context:u,x:r,y:c,style:a,width:e}),h+=e,r+=e,o.textData[n].lineWidth=h)}else o.textData[n].data.push({context:l,x:r,y:c,style:a,width:e}),h+=e,r+=e,o.textData[n].lineWidth=h}),e.forin(this.textData,function(t,e){var a=0;e.lineWidth<i.width&&("center"==i.align?a=(i.width-e.lineWidth)/2:"right"==i.align&&(a=i.width-e.lineWidth)),e.data.forEach(function(t){t.x+=a,o._fillText(t)})})},t.prototype._fillText=function(t){var i=t.context,e=t.x,o=t.y,a=t.style;this.ctx.font=a.font,this.ctx.textAlign=a.align,this.ctx.textBaseline="bottom",this.ctx.fillStyle=a.color,this.ctx.fillText(i,e,o)},t.prototype._get=function(t,i,e,o){var a=e;if("string"==typeof e)if(-1!==e.indexOf(":")&&"pos"==o){var n=e.split(":");switch(n[0]){case"left":case"top":a=+n[1].replace("px","");break;case"right":case"bottom":a=t-+n[1].replace("px","")-i}}else a=-1!==e.indexOf("px")?+e.replace("px",""):-1!==e.indexOf("%")?"crop"==o?i*+e.replace("%","")/100:t*+e.replace("%","")/100:"center"==e?(t-i)/2:+e;return a},t.prototype.draw=function(){var t=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){},e=void 0;return this.end=function(){setTimeout(function(){e=t.canvas.toDataURL("image/png"),i(e)},0)},this._next(),this},t.prototype._next=function(){this.queue.length>0?this.queue.shift()():this.end()},t});
//# sourceMappingURL=mcanvas.min.js.map
